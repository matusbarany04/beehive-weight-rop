<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Notifications.svelte.js</title>

    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="./build/entry.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"
      integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"
      crossorigin="anonymous"
    />
    <link
      type="text/css"
      rel="stylesheet"
      href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css"
    />
    <link type="text/css" rel="stylesheet" href="styles/app.min.css" />
    <link type="text/css" rel="stylesheet" href="styles/iframe.css" />
    <link type="text/css" rel="stylesheet" href="" />
    <script async defer src="https://buttons.github.io/buttons.js"></script>
  </head>

  <body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>

    <div class="top-nav">
      <div class="inner">
        <a
          id="hamburger"
          role="button"
          class="navbar-burger"
          aria-label="menu"
          aria-expanded="false"
        >
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
        <div class="logo"></div>
        <div class="menu">
          <div class="navigation">
            <a href="index.html" class="link"> Documentation </a>
          </div>
        </div>
      </div>
    </div>
    <div id="main">
      <div class="sidebar" id="sidebarNav">
        <nav>
          <h2><a href="index.html">Documentation</a></h2>
          <div class="category">
            <h3>Global</h3>
            <ul>
              <li><a href="global.html#askPermission">askPermission</a></li>
              <li><a href="global.html#getCookie">getCookie</a></li>
              <li>
                <a href="global.html#registerServiceWorker"
                  >registerServiceWorker</a
                >
              </li>
              <li><a href="global.html#remove">remove</a></li>
              <li><a href="global.html#setRead">setRead</a></li>
            </ul>
          </div>
        </nav>
      </div>
      <div class="core" id="main-content-wrapper">
        <div class="content">
          <header class="page-title">
            <p>Source</p>
            <h1>Notifications.svelte.js</h1>
          </header>

          <section>
            <article>
              <pre class="prettyprint source linenums"><code>
  /**
   *
   * This page displays notifications from beehives
   *
   * @class Notification
   * @constructor
   */
  
  import { onMount } from "svelte";
  import Button from "../../../components/Buttons/Button.svelte";
  import CircleButton from "../../../components/Buttons/CircleButton.svelte";
  import { fade, fly } from "svelte/transition";
  import { dataHandler } from "../component/cards/dataHandler";
  import SockJS from "../../../components/lib/stock-min";
  import { Stomp } from "../../../components/lib/stomp-min";
  /*
  var stompClient = null;

  var socket = new SockJS('/ws');
  stompClient = Stomp.over(socket);
  stompClient.connect({}, function(frame) {
    console.log(frame);
    stompClient.subscribe('/all/messages', function(result) {
      show(JSON.parse(result.body));
    });
  });*/

  let messages = [];

  fetch("/dashboardApi/getNotifications")
    .then((response) => {
      if (!response.ok) {
        throw new Error("Network response was not ok");
      }
      return response.json();
    })
    .then((data) => {
      console.log(data);
      messages = data.notifications;
    })
    .catch((error) => {
      console.error(
        "There was a problem with the fetch operation:",
        error.message,
      );
    });

  /**
   * Sets notification to state 'read'
   * @param id id of the notification
   */
  const setRead = (id) => {
    messages.forEach((element) => {
      if (element.id === id) {
        element.seen = !element.seen;
        fetch("", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            type: "update",
            data: id,
            token: data.sessionid,
          }),
        })
          .then((response) => response.json())
          .then((data) => console.log(data))
          .catch((error) => console.error("Error:", error));
      }
    });
    //TODO post marked as read
    messages = [...messages];
  };

  /**
   * Deletes notification from database and removes it from page
   * @param id id of the notification
   */
  const remove = (id) => {
    const index = messages
      .map(function (e) {
        return e.id;
      })
      .indexOf(id);

    if (index > -1) {
      //TODO rewrite remove
      // POST(
      //   "",
      //   JSON.stringify({
      //     type: "delete",
      //     data: id,
      //     token: data.sessionid,
      //   }),
      // ).then((data) => console.log(data));

      messages.splice(index, 1);
    }
    messages = [...messages];
  };

  /*
  let socket = new SockJS('/ws')
  let privateStompClient = Stomp.over(socket)
  privateStompClient.connect({}, function (frame) {
    console.log(frame)
    privateStompClient.subscribe('/user/specific', function (result) {
      console.log(result.body)
      console.log("message");
    //  show(JSON.parse(result.body))
    });
  })

  socket = new SockJS('/ws');
  let stompClient = Stomp.over(socket);
  stompClient.connect({}, function(frame) {
    console.log(frame);
    stompClient.subscribe('/all/messages', function(result) {
      
    });
    setTimeout(() => sendPrivateMessage(), 3000);
  });

  function sendPrivateMessage() {
    stompClient.send("/app/application", {},
      JSON.stringify({text:"hello", to:"test"}));
  }*/

  /**
   * Registers a service worker that tries to send continuous notifications even when page is closed
   */
  function registerServiceWorker() {
    console.log("register...");
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("../js/service-worker.js?token=" + getCookie("sessionid"))
        .then(function (registration) {
          console.log("Service worker successfully registered.");
          return registration;
        })
        .catch(function (err) {
          console.error("Unable to register service worker.", err);
        });
    } else console.log("Your browser does not support service workers.");
  }

  /**
   * Asks for permission to send notifications trough browser
   */
  function askPermission() {
    return new Promise(function (resolve, reject) {
      const permissionResult = Notification.requestPermission(
        function (result) {
          resolve(result);
        },
      );

      if (permissionResult) {
        permissionResult.then(resolve, reject);
      }
    }).then(function (permissionResult) {
      if (permissionResult !== "granted") {
        throw new Error("We weren't granted permission.");
      } else {
        // registerServiceWorker();
        //const notification = new Notification("Test", {body: "this is body", data: {}, icon: "/img/beeman.png"});
      }
    });
  }

  /** 
   * Gets a cookie by name
   * @param name
   */
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
    return null;
  }

  askPermission();

  onMount(() => {
    registerServiceWorker();
  });

  function initialiseState() {
    // Are Notifications supported in the service worker?
    if (!("showNotification" in ServiceWorkerRegistration.prototype)) {
      console.warn("Notifications aren't supported.");
      return;
    }

    // Check the current Notification permission.
    // If its denied, it's a permanent block until the
    // user changes the permission
    if (Notification.permission === "denied") {
      console.warn("The user has blocked notifications.");
      return;
    }

    // Check if push messaging is supported
    if (!("PushManager" in window)) {
      console.warn("Push messaging isn't supported.");
      return;
    }

    // We need the service worker registration to check for a subscription
    navigator.serviceWorker.ready.then(function (serviceWorkerRegistration) {
      // Do we already have a push message subscription?
      serviceWorkerRegistration.pushManager
        .getSubscription()
        .then(function (subscription) {
          // Enable any UI which subscribes / unsubscribes from
          // push messages.

          if (!subscription) {
            // We aren't subscribed to push, so set UI
            // to allow the user to enable push
            return;
          }

          //TODO create method
          // Keep your server in sync with the latest subscriptionId
          sendSubscriptionToServer(subscription);

          // Set your UI to show they have subscribed for
          // push messages
        })
        .catch(function (err) {
          console.warn("Error during getSubscription()", err);
        });
    });

    self.addEventListener("push", function (event) {
      console.log("Received a push message", event);

      const title = "Yay a message.";
      const body = "We have received a push message.";
      const icon = "/images/icon-192x192.png";
      const tag = "simple-push-demo-notification-tag";

      event.waitUntil(
        self.registration.showNotification(title, {
          body: body,
          icon: icon,
          tag: tag,
        }),
      );
    });
  }
</code></pre>
            </article>
          </section>
        </div>

        <footer class="footer">
          <div class="content has-text-centered">
            <p>
              Documentation generated by
              <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a>
            </p>
            <p class="sidebar-created-by">
              <a
                href="https://github.com/SoftwareBrothers/better-docs"
                target="_blank"
                >BetterDocs theme</a
              >
              provided with <i class="fas fa-heart"></i> by
              <a href="http://softwarebrothers.co" target="_blank"
                >SoftwareBrothers - JavaScript Development Agency</a
              >
            </p>
          </div>
        </footer>
      </div>
      <div id="side-nav" class="side-nav"></div>
    </div>
    <script src="scripts/app.min.js"></script>
    <script>
      PR.prettyPrint();
    </script>
    <script src="scripts/linenumber.js"></script>
  </body>
</html>
